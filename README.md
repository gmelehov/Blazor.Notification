# Blazor.Notification


Концепция проекта - онлайн-чат на основе SignalR и Blazor.

<br>

### Blazor.Notification.Models
Модели, используемые приложением.


### Blazor.Notification.Services
Интерфейсы сервисов.


### Blazor.Notification.SignalR
Бэкенд - веб-приложение ASP.NET Core с хабом SignalR, контекст БД Entity Framework Core (LocalDb).  


### Blazor.Notification.Client
Клиентская часть - компоненты Blazor в связке с JavaScript-клиентом для хаба SignalR (на TypeScript).

<br>


## Особенности решения


### Чаты

#### Общий чат
Общий чат включает в себя сообщения, отправленные системой или одним из клиентов сразу всем активным клиентам в режиме рассылки.  
В рамках проекта, «уведомление» = сообщение, отправленное не клиентом, а системой.  

#### Приватные чаты
Приватные чаты содержат переписку между двумя конкретными клиентами в режиме адресной рассылки.  
Приватный чат возможен исключительно между двумя (не более) клиентами, ни один из которых не является «системой».  
Содержание каждого приватного чата изолировано как от общего, так и от любого другого приватного чата и доступно/видимо только в тех вкладках браузера, которые сопоставлены с получателем и отправителем сообщений в данном конкретном приватном чате.  

<br>


### Сообщение/уведомление
Модель сообщения построена по принципу «один отправитель = несколько получателей», при этом отправитель одновременно может выступать и в роли получателя своего же сообщения. Причина в том, что любое сообщение при его отправке (в рамках проекта) автоматически считается прочитанным только для его отправителя, но ни для одного из его получателей - сообщение считается непрочитанным до тех пор, пока его получатель не вернется к своей вкладке браузера и не сделает ее «активной» (см. ниже), а это может происходить в разное время, либо не происходить вообще. Соответственно, для каждого из получателей необходимо иметь свой, входящий, «инстанс» отправленного для него сообщения, в котором отслеживается статус «прочитано», а также время присвоения этого статуса.  

#### Основные атрибуты исходящего сообщения/уведомления
- уникальный идентификатор (типа `int`)  
- тип сообщения (системное/клиентское)  
- маршрут сообщения (в общий чат/в приватный чат)  
- текст  
- ссылка на отправителя сообщения  
- список клиентов-получателей (на момент отправки сообщения)  

#### Основные атрибуты входящего сообщения/уведомления
- уникальный идентификатор (типа `int`)  
- текущий статус сообщения (отправлено/прочитано)  
- ссылка на само сообщение  
- ссылка на клиента-получателя  

<br>


### Клиент
Клиентом считается каждая вкладка/окно браузера с загруженной страницей приложения - https://localhost:7211.  
Клиент остается активным до тех пор, пока не закрыта соответствующая вкладка/окно браузера.  
Клиент - не то же, что и подключение к хабу SignalR, разница между ними описана ниже.  

#### Основные атрибуты клиента
- уникальный идентификатор (типа `int`)  
- сопоставленный с клиентом идентификатор подключения к хабу SignalR  
- ссылка на предыдущее подключение к хабу  
- название клиента (строка в формате `client # {CLIENT ID}`)  
- статус «активности» (`true`, пока существует вкладка/окно браузера, сопоставленная с этим клиентом = клиент online, `false`, после закрытия вкладки/окна браузера = клиент оффлайн)  


#### Поведение при открытии новой вкладки
При открытии новой вкладки/окна браузера и загрузке страницы приложения выполняются следующие действия:  
- создание нового подключения к хабу SignalR  
- создание нового клиента, сопоставленного с этой вкладкой/окном и этим подключением к хабу  

Новую вкладку браузера со страницей приложения можно открыть, кликнув по заголовку приложения (`Blazor.Notification`).  

#### Поведение при перезагрузке вкладки
При перезагрузке любой вкладки происходит следующее:  
- подключение к хабу SignalR для этой вкладки, активное ДО момента перезагрузки, закрывается (становится неактивным) и записывается в историю подключений клиента, сопоставленного с этой вкладкой  
- создается новое подключение к хабу SignalR, которое становится активным для этого клиента  
- все входящие/исходящие сообщения клиента (включая системные уведомления для него) полностью сохраняются  

Таким образом, при перезагрузке любой вкладки клиент всегда остается одним и тем же, меняется лишь его текущее подключение к хабу SignalR, по принципу «один клиент = много подключений к хабу SignalR». По сути, у каждого клиента есть своя история подключений к хабу со множеством закрытых (неактивных) и одним-единственным активным подключением к хабу.  

#### Поведение при переключении вкладок
- вкладка браузера с клиентским подключением, потерявшая фокус (вкладка, С КОТОРОЙ переключились), становится неактивной  
- вкладка браузера с клиентским подключением, получившая фокус (вкладка, НА КОТОРУЮ переключились), становится активной  

При любом переключении вкладок все клиенты всегда остаются активными, т.е. не теряют подключения к хабу, продолжают принимать уведомления/сообщения и сохраняют полную функциональность, за одним исключением - клиент, подключенный к **неактивной** вкладке браузера, автоматически НЕ помечает входящие уведомления/сообщения прочитанными, в отличие от клиента, подключенного к **активной** вкладке.  

#### Поведение при закрытии вкладки
При закрытии вкладки/окна браузера клиент становится неактивным, история его подключений к хабу далее не отслеживается, а его переподключение становится невозможным.  


<br>

### Система
В рамках приложения, «система» = клиент, физически не подключенный к хабу SignalR, но имеющий возможность отправлять сообщения/уведомления в общий чат, в том числе и по расписанию, по итогам выполнения фоновых задач.  


<br>

### Список клиентов
В любой вкладке, в которой открыто клиентское подключение к серверу, доступен список активных клиентов - тех, которые находятся в режиме онлайн, способны принимать и отправлять сообщения.  
В начале списка всегда находится текущее клиентское подключение - название того клиента, браузерная вкладка с которым открыта в настоящий момент.  
Пользователь может выбрать любого клиента, кроме текущего, кликнув по соответствующей строке в списке клиентов (строка с выбранным клиентом подсвечивается).  

#### Поведение при выборе клиента из списка
В текущей вкладке браузера:  
- окно для ввода текста исходящего сообщения начинает работать в режиме «отправка сообщения в приватный чат»  
- изменяется текст кнопки для отправки сообщения (отображается текст в формате `SEND TO client # {CLIENT ID}`)  
- в секции `Private chat` становится доступна история входящих/исходящих сообщений (приватный чат) между текущим и выбранным в списке клиентом  

#### Поведение при снятии выбора с клиента из списка
В текущей вкладке браузера:  
- окно для ввода текста исходящего сообщения начинает работать в режиме «отправка сообщения в общий чат»  
- изменяется текст кнопки для отправки сообщения (отображается текст `SEND TO COMMON CHAT`)  
- в секции `Private chat` скрывается история входящих/исходящих сообщений (приватный чат) между текущим и тем клиентом, выбор в списке с которого был снят  